// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  MASTER
  DEV
  COLABORADOR
}

model Admin {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      AdminRole @default(COLABORADOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  systemLogs   System[]
  services     Service[]
  servicesHead Service[] @relation("ServiceHead")
  modules      ServiceModule[] @relation("ModuleCollaborators")

  @@map("admins")
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  slug      String   @unique // Para acesso via URL: api.$[dominio]/$[slug.user]/...
  password  String
  
  // Detalhes do Cliente
  document    String?  // CPF ou CNPJ
  phone       String?
  plan        String?  // FREE, PRO, ENTERPRISE
  
  // Endereço
  address     String?
  city        String?
  state       String?
  zipCode     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userSystemLogs UserSystem[]
  credentials    Credential[]
  services       Service[]
  invoices       Invoice[]
  tickets        Ticket[]
  marketing      MarketingSettings?
  seo            SeoSettings?
  datasets       TrackingDataset[]
  cmsTypes       CmsContentType[]

  dataSources    DataSource[]
  products       Product[]
  campaigns      Campaign[]
  teamMembers    TeamMember[]
  teams          Team[]
  crmContacts    CrmContact[]
  crmPipelines   CrmPipeline[]
  crmDeals       CrmDeal[]
  forms          Form[]

  @@map("users")
}

model MarketingSettings {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  
  metaPixelId        String?
  metaApiToken       String?
  metaAdAccountId    String?
  
  tiktokPixelId      String?
  tiktokAccessToken  String?
  tiktokAdvertiserId String?
  
  googleConversionId    String?
  googleConversionLabel String?
  googleAccessToken     String?
  googleCustomerId      String?
  
  createdAt          DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("marketing_settings")
}

model SeoSettings {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  
  // Metatags Globais
  globalTitle       String?
  globalDescription String?
  
  // Integrações
  googleSearchConsoleId String?
  googleAnalyticsId     String?
  
  // Lista de Keywords (JSON array)
  targetKeywords    Json?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("seo_settings")
}

model TrackingDataset {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  destinations TrackingDestination[]
  sources      TrackingSource[]
  events       TrackingEvent[]
  deliveries   TrackingEventDelivery[] // Relação para fácil acesso, se necessário

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tracking_datasets")
}

model TrackingEvent {
  id          String          @id @default(cuid())
  datasetId   String
  dataset     TrackingDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  
  eventId     String?         // External ID (deduplication key)
  eventName   String
  eventData   Json?
  
  url         String?
  userAgent   String?
  ip          String?
  
  status      String          @default("PROCESSED") 
  
  deliveries  TrackingEventDelivery[]

  createdAt   DateTime        @default(now())

  @@index([datasetId])
  @@index([eventId])
  @@map("tracking_events")
}

model TrackingEventDelivery {
  id              String              @id @default(cuid())
  eventId         String
  event           TrackingEvent       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  destinationId   String
  destination     TrackingDestination @relation(fields: [destinationId], references: [id], onDelete: Cascade)
  
  // Relação opcional com Dataset para facilitar queries agregadas, se necessário
  datasetId       String?
  dataset         TrackingDataset?    @relation(fields: [datasetId], references: [id])

  status          String              // PENDING, SUCCESS, FAILED
  responseCode    Int?
  responseBody    String?             @db.Text
  
  attemptCount    Int                 @default(1)
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([eventId])
  @@index([destinationId])
  @@map("tracking_event_deliveries")
}

enum DestinationPlatform {
  META
  TIKTOK
  GOOGLE_ADS
}

model TrackingDestination {
  id          String              @id @default(cuid())
  datasetId   String
  dataset     TrackingDataset     @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  platform    DestinationPlatform
  enabled     Boolean             @default(true)
  
  // Platform specific config stored in JSON
  // Meta: { pixelId, apiToken }
  // TikTok: { pixelId, accessToken }
  // Google: { conversionId, label }
  config      Json

  deliveries  TrackingEventDelivery[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tracking_destinations")
}

enum SourceType {
  WEBHOOK
  PIXEL_SCRIPT
  CRM
  MANUAL
}

enum WebhookProvider {
  STRIPE
  SHOPIFY
  HOTMART
  CUSTOM
}

enum SourceStatus {
  PENDING
  ACTIVE
  ERROR
}

model TrackingSource {
  id          String          @id @default(cuid())
  datasetId   String
  dataset     TrackingDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  type        SourceType
  provider    WebhookProvider? // If type == WEBHOOK
  
  name        String
  enabled     Boolean         @default(true)
  status      SourceStatus    @default(PENDING)

  // Config (e.g. webhook secret, specific mapping rules)
  config      Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tracking_sources")
}

model System {
  id          String   @id @default(cuid())
  action      String
  description String?
  adminId     String
  createdAt   DateTime @default(now())
  
  admin       Admin    @relation(fields: [adminId], references: [id])

  @@map("system_logs")
}

model UserSystem {
  id          String   @id @default(cuid())
  action      String
  description String?
  userId      String
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])

  @@map("user_system_logs")
}

model Credential {
  id          String   @id @default(cuid())
  serviceName String
  apiKey      String
  apiSecret   String?
  meta        Json?    // Para guardar informações extras flexíveis
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id])

  @@map("credentials")
}

enum ServiceStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Service {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      ServiceStatus @default(ACTIVE)
  sector      String?       // e.g. "Marketing", "Development"
  features    String[]
  
  headId      String?
  head        Admin?        @relation("ServiceHead", fields: [headId], references: [id])
  
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  
  collaborators Admin[]     // Squad responsible for this service
  
  modules     ServiceModule[]
  
  invoices    Invoice[]
  
  campaigns      Campaign[]
  teamMembers    TeamMember[]
  checkoutSettings CheckoutSettings?
  checkoutTemplates CheckoutTemplate[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("services")
}

model CheckoutTemplate {
  id          String   @id @default(cuid())
  name        String
  type        String   // EMBEDDED | ELEMENTS
  isDefault   Boolean  @default(false)
  
  // Configuration
  config      Json     // Stores visual settings (color, radius, etc.) and behavior options
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("checkout_templates")
}

model ServiceModule {
  id          String   @id @default(cuid())
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  key         String   // e.g. "cms", "marketing"
  name        String
  description String?
  status      ServiceStatus @default(ACTIVE)
  
  collaborators Admin[] @relation("ModuleCollaborators")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([serviceId, key])
  @@map("service_modules")
}

model Invoice {
  id        String        @id @default(cuid())
  amount    Decimal       @db.Decimal(10, 2)
  status    InvoiceStatus @default(PENDING)
  dueDate   DateTime
  paidDate  DateTime?
  serviceId String?
  service   Service?      @relation(fields: [serviceId], references: [id])
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  createdAt DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("invoices")
}

model Ticket {
  id        String         @id @default(cuid())
  subject   String
  message   String         @db.Text
  status    TicketStatus   @default(OPEN)
  priority  TicketPriority @default(MEDIUM)
  userId    String
  user      User           @relation(fields: [userId], references: [id])
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@map("tickets")
}

model CmsContentType {
  id          String   @id @default(cuid())
  name        String   // e.g. "Blog Post"
  slug        String   // e.g. "blog-post"
  description String?
  
  // Defines the schema structure (fields: text, image, etc.)
  // Format: [{ "key": "title", "type": "text", "required": true }, ...]
  fields      Json     
  
  // Mapping Resolver: 'products', 'blog', 'standard'
  resolver    String?  @default("standard")
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  entries     CmsContentEntry[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, slug])
  @@map("cms_content_types")
}

model CmsContentEntry {
  id            String   @id @default(cuid())
  
  contentTypeId String
  contentType   CmsContentType @relation(fields: [contentTypeId], references: [id], onDelete: Cascade)
  
  // Actual content data matching the schema
  // Format: { "title": "My Post", "body": "..." }
  data          Json
  
  // Status: DRAFT, PUBLISHED, ARCHIVED
  status        String   @default("DRAFT")
  
  // SEO / Access
  slug          String?  // Custom slug for fetching content, e.g. "my-first-post"
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([contentTypeId])
  @@unique([contentTypeId, slug])
  @@map("cms_content_entries")
}

model DataSource {
  id            String   @id @default(cuid())
  name          String
  type          String   // STRIPE, FORM, PRODUCT, CAMPAIGN, TRACKING, CMS
  integrationId String?  // ID of the linked entity (formId, campaignId, etc.)
  config        Json?
  status        String   @default("ACTIVE")
  
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  lastSyncedAt  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  checkoutSettings CheckoutSettings[]

  @@index([userId, type])
  @@index([integrationId])
  @@map("data_sources")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal  @default(0) @db.Decimal(10, 2)
  currency    String?
  sku         String?
  image       String?
  source      String?
  tags        String[]
  variants    Json?
  active      Boolean  @default(true)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

model Form {
  id          String   @id @default(cuid())
  title       String
  description String?
  schema      Json
  redirectUrl String?
  status      String   @default("ACTIVE")
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  submissions FormSubmission[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([id, userId])
  @@map("forms")
}

model FormSubmission {
  id        String   @id @default(cuid())
  data      Json
  ip        String?
  userAgent String?
  referer   String?
  
  formId    String
  form      Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@map("form_submissions")
}

model Campaign {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      String   @default("ACTIVE")
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("campaigns")
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  members     TeamMember[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      TeamRole @default(MEMBER)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  teams     Team[]
  allowedServices Service[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("team_members")
}

model CrmContact {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  jobTitle  String?
  company   String?
  type      String   @default("LEAD")
  source    String?
  tags      String[]
  customFields Json?
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  deals     CrmDeal[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crm_contacts")
}

model CrmPipeline {
  id        String   @id @default(cuid())
  name      String
  isDefault Boolean  @default(false)
  stages    CrmStage[]
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  deals     CrmDeal[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crm_pipelines")
}

model CrmStage {
  id        String   @id @default(cuid())
  name      String
  color     String?
  order     Int      @default(0)
  
  pipelineId String
  pipeline   CrmPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  deals      CrmDeal[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crm_stages")
}

model CrmDeal {
  id          String   @id @default(cuid())
  title       String
  value       Decimal  @default(0) @db.Decimal(10, 2)
  status      String   // OPEN, WON, LOST
  
  stageId     String
  stage       CrmStage @relation(fields: [stageId], references: [id])
  
  contactId   String?
  contact     CrmContact? @relation(fields: [contactId], references: [id])
  
  pipelineId  String
  pipeline    CrmPipeline @relation(fields: [pipelineId], references: [id])
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("crm_deals")
}

model CheckoutSettings {
  id        String   @id @default(cuid())
  serviceId String   @unique
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Fonte de Dados (DataSource)
  dataSourceId String?
  dataSource   DataSource? @relation(fields: [dataSourceId], references: [id])

  // Pixels
  facebookPixelId String?
  googlePixelId   String?
  tiktokPixelId   String?

  // Config
  collectPhone    Boolean @default(true)
  collectAddress  Boolean @default(true)
  onePageCheckout Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("checkout_settings")
}
